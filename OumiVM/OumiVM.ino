/* ================================================================== */
/* =                       OumiVM.ino                               = */
/* ================================================================== */

#include "vm.h"

/* --- AQUÍ PEGAS EL BYTECODE DE TU PC --- */
// (Mismo bytecode que compartiste al inicio)
const Value CONSTANT_POOL[] = {
    115.000000, 20.000000, 115.000000, 0.000000, 0.000000,
    32.000000, 20.000000, 115.000000, 0.000000, 0.000000,
    115.000000, 20.000000, 32.000000, 0.000000, 0.000000,
    8.000000, 9.000000, 0.000000, 0.000000, 1.000000,
    0.000000, 0.000000, 3.000000, 1.000000, 0.000000,
    55.000000, 0.000000, 1.000000, 29.000000, 20.000000,
};
#define CONSTANT_COUNT 30

const byte BYTECODE[] = {
    0x12, 0x00, 0x17, 0x00, 0x00, 0x00, 0x01, 0x03, 0x0E, 0x00,
    0x00, 0x02, 0x00, 0x03, 0x03, 0x0E, 0x01, 0x0F, 0x00, 0x1F,
    0x0F, 0x01, 0x1E, 0x00, 0x04, 0x16, 0x12, 0x00, 0x17, 0x00,
    0x05, 0x00, 0x06, 0x03, 0x0E, 0x02, 0x00, 0x07, 0x00, 0x08,
    0x03, 0x0E, 0x03, 0x0F, 0x02, 0x1F, 0x0F, 0x03, 0x1E, 0x00,
    0x09, 0x16, 0x12, 0x00, 0x17, 0x00, 0x0A, 0x00, 0x0B, 0x03,
    0x0E, 0x04, 0x00, 0x0C, 0x00, 0x0D, 
    0x03, 0x0E, 0x05, 0x0F,
    0x04, 0x1F, 0x0F, 0x05, 0x1E, 0x00, 0x0E, 0x16, 0x00, 0x0F,
    0x0E, 0x06, 0x00, 0x10, 0x0E, 0x07, 0x00, 0x11, 0x0E, 0x08,
    0x00, 0x12, 0x0E, 0x09, 0x00, 0x13, 0x13, 0x00, 0x53, 0x0F,
    0x06, 0x21, 0x0E, 0x08, 0x0F, 0x07, 0x21, 0x0E, 0x09, 0x0F,
    0x08, 0x00, 0x14, 0x09, 0x0F, 0x09, 0x00, 0x15, 0x09, 0x0C,
    0x13, 0x00, 0x08, 0x00, 0x16, 0x15, 0x00, 0x01, 0x12, 0x00,
    0x2D, 0x0F, 0x08, 0x00, 0x17, 0x09, 0x0F, 0x09, 0x00, 0x18,
    0x09, 0x0C, 
    0x13, 0x00, 0x08, 0x00, 0x19, 0x15, 0x00, 0x01, 
    0x12, 0x00, 0x17, 0x0F, 0x08, 0x00, 0x1A, 0x09, 0x0F, 0x09,
    0x00, 0x1B, 0x09, 0x0C, 0x13, 0x00, 0x08, 0x00, 0x1C, 0x15,
    0x00, 0x01, 0x12, 0x00, 0x01, 0x20, 0x00, 0x1D, 0x19, 0x14,
    0x00, 0x58, 0x02,
};

VM vm;

void setup() {
  Serial.begin(9600);
  Serial.println("--- VM del Robot Iniciada con Calibracion ---");

  // --- CONFIGURACIÓN DE PINES ---
  // Copiados exactamente de tu código funcional 
  pinMode(5, OUTPUT); // ENA
  pinMode(6, OUTPUT); // ENB
  pinMode(2, OUTPUT); // IN1
  pinMode(3, OUTPUT); // IN2
  pinMode(4, OUTPUT); // IN3
  pinMode(7, OUTPUT); // IN4
  
  // Sensores como entrada
  pinMode(8, INPUT); // SENSOR IZQ
  pinMode(9, INPUT); // SENSOR DER

  // Inicializa la VM
  vm_init(&vm);
  
  // Carga el bytecode y las constantes
  vm_load_bytecode(&vm, (byte*)BYTECODE);
  
  for(int i = 0; i < CONSTANT_COUNT; i++) {
    vm_add_constant(&vm, CONSTANT_POOL[i]);
  }
  
  Serial.println("Bytecode cargado. Iniciando ejecucion.");
}

void loop() {
  InterpretResult resultado = vm_interpretar(&vm);

  if (resultado == INTERPRET_RUNTIME_ERROR) {
    Serial.println("--- Error de Runtime de la VM ---");
    while(1); 
  }
  if (resultado == INTERPRET_OK) {
     Serial.println("--- Programa finalizado (OP_HALT) ---");
     while(1); 
  }
}